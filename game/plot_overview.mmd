graph TD
    Start[Начало: Сон о белом коне] --> Prep[Подготовка в деревне]
    Prep --> Stars[Урок 1: Звёзды]
    Stars --> Sokol[Встреча с Соколом]
    Sokol --> Riddles[Урок 2: Загадки и ритм]
    Riddles --> Route[Выбор навигации и пути]
    Route --> Herbs[Урок 3: Травы]
    Herbs --> Valley[Долина Эха]
    Valley --> Battle[Битва с Адзахи]
    Battle --> Feather{Взять перо?}
    Feather -->|Да| Endings[Проверка условий концовок]
    Feather -->|Нет| Retreat[Конец: Отступление]

    %% Ключевые развилки навыков
    Stars -->|успех/провал| S1[navigation_stars]
    Riddles -->|успех/провал| S2[speech_rhythm]
    Herbs -->|успех/провал| S3[herbs_knowledge]

    %% Стили
    classDef start fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef lesson fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef battle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef ending fill:#e8eaf6,stroke:#1a237e,stroke-width:2px

    class Start start
    class Stars,Riddles,Herbs lesson
    class Battle battle
    class Retreat,Endings ending
